<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cool Website</title>
</head>
<body>
    <h1>Welcome to my website! ⭐️</h1>
    <p>Knock, knock! What's your secret?</p>
    <input type="password" id="passwordInput" placeholder="Enter secret">
    <p id="output"></p>

    <script>
        const encrypted = encryptCode("alert('Decrypted code is running!');", "pass");
        console.log(encrypted)

        // Convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Convert string to ArrayBuffer
        function stringToArrayBuffer(str) {
            return new TextEncoder().encode(str).buffer;
        }

        // Derive key from password using PBKDF2
        async function deriveKey(password, salt) {
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                stringToArrayBuffer(password),
                { name: "PBKDF2" },
                false,
                ["deriveBits", "deriveKey"]
            );
            return window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                true,
                ["decrypt"]
            );
        }

        async function encryptCode(code, password) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12)); // 12-byte IV for AES-GCM
            const salt = window.crypto.getRandomValues(new Uint8Array(16)); // Salt for PBKDF2
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                new TextEncoder().encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveBits", "deriveKey"]
            );
            const key = await window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt"]
            );
            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                key,
                new TextEncoder().encode(code)
            );
            // Convert to base64

            return {
                encryptedBase64: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
                ivBase64: btoa(String.fromCharCode(...iv)),
                saltBase64: btoa(String.fromCharCode(...salt))
            }
        }
        
        // Decrypt and run code
        async function decryptAndRun({ encryptedBase64: "", ivBase64: "", saltBase64: ""})
            }) {
            const password = document.getElementById('passwordInput').value;
            const output = document.getElementById('output');

            try {
                const encryptedData = base64ToArrayBuffer(encryptedBase64);
                const iv = base64ToArrayBuffer(ivBase64);
                const salt = base64ToArrayBuffer(saltBase64);

                const key = await deriveKey(password, salt);

                // Decrypt
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encryptedData
                );

                const decryptedCode = new TextDecoder().decode(decrypted);

                eval(decryptedCode);
                output.textContent = "I know your secret :)";
            } catch (error) {
                output.textContent = "I know your secret :).";
            }
        }

        // Add event listener for Enter key press
        document.getElementById('passwordInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                decryptAndRun(encrypted);
            }
        });
    </script>
</body>
</html>
